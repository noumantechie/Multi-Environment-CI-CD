name: ðŸš€ CD - Deploy to K8s

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'ðŸŽ¯ Target Environment'
        required: true
        type: choice
        options:
          - testing
          - qa
      image_tag:
        description: 'ðŸ·ï¸ Docker Image Tag'
        required: true
        type: string

env:
  DOCKER_IMAGE: noman071/myapp

jobs:
  show-available-tags:
    runs-on: ubuntu-latest
    name: ðŸ“‹ Show Available Tags
    
    steps:
      - name: ðŸ“‹ Fetch Tags from Docker Hub
        run: |
          echo "### ðŸ·ï¸ Available Docker Hub Tags (Last 20)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          TAGS=$(curl -s "https://hub.docker.com/v2/repositories/${{ env.DOCKER_IMAGE }}/tags/?page_size=20" | \
            jq -r '.results[] | select(.name != "buildcache" and .name != "latest") | "\(.name) (\(.last_updated[:10]))"')
          
          if [ -z "$TAGS" ]; then
            echo "No tags found" >> $GITHUB_STEP_SUMMARY
          else
            echo "$TAGS" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Selected:** \`${{ github.event.inputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: show-available-tags
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'
      
      - name: ðŸ” Configure Kubeconfig
        run: |
          mkdir -p ~/.kube
          ENV="${{ github.event.inputs.environment }}"
          
          if [ "$ENV" == "testing" ]; then
            echo "${{ secrets.KUBECONFIG_testing }}" | base64 -d > ~/.kube/config
          elif [ "$ENV" == "qa" ]; then
            echo "${{ secrets.KUBECONFIG_qa }}" | base64 -d > ~/.kube/config
          fi
          
          chmod 600 ~/.kube/config
          kubectl get pods -n $ENV --request-timeout=10s || true
      
      - name: ðŸ”„ Update Deployment
        run: |
          ENV="${{ github.event.inputs.environment }}"
          IMAGE="${{ env.DOCKER_IMAGE }}:${{ github.event.inputs.image_tag }}"
          
          sed -i "s|image:.*myapp:.*|image: $IMAGE|g" k8s/deployment.yaml
          grep "image:" k8s/deployment.yaml
      
      - name: ðŸš€ Apply Manifests
        run: |
          ENV="${{ github.event.inputs.environment }}"
          kubectl apply -n $ENV -f k8s/service.yaml
          kubectl apply -n $ENV -f k8s/deployment.yaml
      
      - name: â³ Wait for Rollout
        run: |
          ENV="${{ github.event.inputs.environment }}"
          kubectl rollout status deployment/myapp -n $ENV --timeout=5m
      
      - name: âœ… Verify Deployment
        run: |
          ENV="${{ github.event.inputs.environment }}"
          
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ### ðŸŽ‰ Deployment Successful!
          
          **Environment:** \`$ENV\`
          **Image:** \`${{ env.DOCKER_IMAGE }}:${{ github.event.inputs.image_tag }}\`
          
          #### Pods:
          \`\`\`
          $(kubectl get pods -n $ENV -l app=myapp)
          \`\`\`
          
          #### Service:
          \`\`\`
          $(kubectl get svc -n $ENV -l app=myapp)
          \`\`\`
          EOF
      
      - name: ðŸ¥ Health Check
        run: |
          ENV="${{ github.event.inputs.environment }}"
          kubectl wait --for=condition=ready pod -l app=myapp -n $ENV --timeout=3m
          echo "âœ… All pods healthy!"